---
- name: Install and update software through apt
  hosts: raspberrypis
  become: true
  tasks:
    - name: Get latest Raspbian updates
      apt: 
        update_cache: yes

    - name: Make sure there are no broken packages
      command: apt-get -y -f install

    - name: Install software
      apt:
        name: "{{ item }}"
        state: latest
      with_items:
        - at-spi2-core
        - florence  
        - realvnc-vnc-server 
        - build-essential 

    - name: Install software from group_vars/raspberrypis.yml
      apt:
        name: "{{ item }}"
        state: present
      with_items: "{{ RASPBIAN_APT_INSTALL }}"

    - name: Install influxdb
      apt:
        deb: https://repos.influxdata.com/debian/pool/stable/i/influxdb/influxdb_1.2.2-1_armhf.deb
      notify: start and enable influxdb

    - name: Install grafana
      apt:
        deb: https://github.com/fg2it/grafana-on-raspberry/releases/download/v4.2.0/grafana_4.2.0_armhf.deb
      notify: start and enable grafana
      tags:
        -grafana

    - name: Ensure grafana is running
      systemd:
        name: grafana-server
        state: started
        enabled: yes
        daemon-reload: yes        
      tags:
        - grafana

  handlers:
    - name: start and enable influxdb
      systemd:
        name: influxdb
        state: started
        enabled: yes

    - name: start and enable grafana
      systemd:
        name: grafana-server
        state: started
        enabled: yes
        daemon-reload: yes





  

  

 
